#pragma once

#include <ping-device.h>

class Ping1d : public PingDevice
{
public:
    /**
     *  @brief Constructor
     *
     *  @param ser: The device I/O
     */
    Ping1d(PingPort& port) : PingDevice(port) {}

    /**
     * @brief Destructor
     */
    ~Ping1d();

    /**
     *  @brief Establish communications with the device, and initialize the update interval
     *
     *  @param ping_interval_ms: The interval (in milliseconds) between acoustic measurements
     *
     *  @return true if the device was initialized successfully
     */
    bool initialize(uint16_t ping_interval_ms = 50);

    /**
     *  @brief Request a ping_message from the device
     *
     *  @param id: The message ID to request
     *  @param timeout_ms: The timeout period to wait for the requested ping_message to be received
     *
     *  @return The ping_message that was requested
     *  @return null if the device did not reply with the requested message before the timeout period expired
     *
     *  @par ex.
     *  @code
     *  ping_msg_ping1D_voltage_5 msg(*pd.request(Ping1dId::Voltage_5));
     *  @endcode
     */
    ping_message* request(uint16_t id, int timeout_ms = 500);
    
{% for msg in messages["set"] %}
    /**
     * @brief {{messages["set"][msg].description}}
     *
{% for field in messages["set"][msg].payload %}
     * @param {{field.name}} - {% if field.units %}Units: {{field.units}}; {% endif %}{{field.description}}
{% endfor %}
     *
     * @return when verify = false: true if a valid reply is received from the device.
     * @return when verify = true: true if a valid reply is received from the
     * device, and the values in the reply match the values that we applied
     */
    bool {{msg}}({% for field in messages["set"][msg].payload %}{{generator.get_type_string(field.type)}} {{field.name}}, {% endfor %}bool verify = true);

{% endfor %}

{% set propnames=[] %}
{% set proplist=[] %}
{% for msg in messages["get"] %}
{% for field in messages["get"][msg].payload %}
{% if field.name not in propnames %}
{{ '' if propnames.append(field.name) -}}
{{ '' if proplist.append(field) -}}
{% endif %}
{% endfor %}
{% endfor %}

{% for field in proplist %}
    /**
     * Return the latest value received
     */
{% if generator.is_vector(field.type) %}
{% if field.vector.sizetype %}
    {{generator.get_type_string(field.vector.sizetype)}} {{field.name}}_length() { return _{{field.name}}_length; }
    /**
     * Return the latest value received
     */
    {{generator.get_type_string(field.vector.datatype)}}* {{field.name}}() { return _{{field.name}}; }
{% endif %}
{% else %}
    {{generator.get_type_string(field.type)}} {{field.name}}() { return _{{field.name}}; }
{% endif %}

{% endfor %}

private:
    /**
     *  @brief Handle an incoming message from the device. Internal values are updated according to the device data.
     *
     *  @param msg: A pointer to the message received from the device
     */
    void _handleMessage(ping_message* msg) override;

{% for field in proplist %}
    // {{field.description}}
{% if generator.is_vector(field.type) %}
{% if field.vector.sizetype %}
    {{generator.get_type_string(field.vector.sizetype)}} _{{field.name}}_length = 0;
{% endif %}
    {{generator.get_type_string(field.vector.datatype)}}* _{{field.name}} = 0;
{% else %}
    {{generator.get_type_string(field.type)}} _{{field.name}} = 0;
{% endif %}

{% endfor %}
};
